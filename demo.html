<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOW-Agent Demo (RU)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; }
    button { padding: 12px 14px; border: 1px solid #ddd; border-radius: 12px; background: #fff; cursor: pointer; text-align: left; }
    button:hover { border-color: #aaa; }
    .box { margin-top: 18px; padding: 14px; border: 1px solid #eee; border-radius: 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
    .primary { background:#111; color:#fff; border-color:#111; }
    .danger { background:#b00020; color:#fff; border-color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>WOW-Agent Demo Hub (RU)</h1>
  <p>–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å ‚Üí —Å—Ç–∞—Ä—Ç ‚Üí <b>60 —Å–µ–∫</b> ‚Üí —Å—Ç–æ–ø —Å–µ—Å—Å–∏–∏ ‚Üí CTA.</p>

  <div class="grid" id="roles">
    <button data-role="sales"><b>–ö–ª–∏–µ–Ω—Ç—ã –∏ –ø—Ä–æ–¥–∞–∂–∏</b><br><small>–∑–∞—è–≤–∫–∏ / –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ / –¥–æ–∂–∏–º</small></button>
    <button data-role="partners"><b>–ü–∞—Ä—Ç–Ω—ë—Ä—ã –∏ –∫–æ–º–∞–Ω–¥–∞</b><br><small>—Ä–µ–∫—Ä—É—Ç–∏–Ω–≥ / –æ–Ω–±–æ—Ä–¥–∏–Ω–≥</small></button>
    <button data-role="investor"><b>–ò–Ω–≤–µ—Å—Ç–æ—Ä</b><br><small>–ø–∏—Ç—á / —Ü–∏—Ñ—Ä—ã / —Ñ–æ—Ä–º–∞—Ç</small></button>
    <button data-role="support"><b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b><br><small>FAQ / —Ä–∞–∑–≥—Ä—É–∑–∫–∞</small></button>
  </div>

  <div class="box">
    <div class="row">
      <label>–ò–º—è:</label>
      <input id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ø–∫–æ–≤" />
      <span>–†–æ–ª—å: <code id="role">‚Äî</code></span>
    </div>

    <div class="row" style="margin-top:12px">
  <button class="primary" id="start">–°—Ç–∞—Ä—Ç (–ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω)</button>
  <button class="danger" id="stop" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>

  <button id="mic" disabled>üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>

  <span>–¢–∞–π–º–µ—Ä: <code id="timer">‚Äî</code></span>
</div>


    <p id="status" style="margin-top:12px">–°—Ç–∞—Ç—É—Å: –∂–¥—ë–º –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏.</p>
    <!-- LiveKit / Avatar view + Debug -->
    <div style="margin-top:14px; display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start;">
      <div id="videoContainer" style="aspect-ratio:16/9; background:#111; border-radius:12px; overflow:hidden; position:relative;">
        <div id="videoHint" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#bbb; font:14px system-ui;">
          –í–∏–¥–µ–æ/–∞—É–¥–∏–æ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è LiveKit
        </div>
      </div>

      <div>
        <div style="font:12px system-ui; opacity:.75; margin:2px 0 6px;">/api/start JSON (debug)</div>
        <pre id="startDebug" style="height:220px; overflow:auto; background:#f7f7f7; border:1px solid #eee; border-radius:12px; padding:10px; white-space:pre-wrap;"></pre>

        <div style="font:12px system-ui; opacity:.75; margin:10px 0 6px;">LiveKit debug</div>
        <pre id="lkDebug" style="height:140px; overflow:auto; background:#f7f7f7; border:1px solid #eee; border-radius:12px; padding:10px; white-space:pre-wrap;"></pre>
      </div>
    </div>

    <!-- –í–ê–ñ–ù–û:
         –¢—É—Ç –ø–æ–∑–∂–µ –≤—Å—Ç–∞–≤–∏–º —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä LiveAvatar —á–µ—Ä–µ–∑ SDK.
         –°–µ–π—á–∞—Å –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É: —Ç–æ–∫–µ–Ω + —Å—Ç–æ–ø. -->
  </div>

  <div class="box">
    <b>CTA –ø–æ—Å–ª–µ –¥–µ–º–æ:</b>
    <p>–•–æ—á–µ—à—å –¥–µ–º–æ –ø–æ–¥ —Ç–≤–æ—é –Ω–∏—à—É –∑–∞ 48 —á–∞—Å–æ–≤? ‚Üí <a href="#">–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å 15 –º–∏–Ω—É—Ç</a></p>
  </div>
<script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>

<script>
  let chosenRole = "sales"; // –ø–æ–∫–∞ —Ñ–∏–∫—Å
  let countdown = null;
  let secondsLeft = 0;

  let sessionId = null;
  let sessionToken = null;

  // LiveKit state
  let room = null;
  let attachedVideoEl = null;
  let attachedAudioEl = null;
let localMicTrack = null;

  const startDebugEl = document.getElementById("startDebug");
  const lkDebugEl = document.getElementById("lkDebug");
  const videoContainer = document.getElementById("videoContainer");
  const videoHint = document.getElementById("videoHint");

  async function postJSON(url, body) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body || {})
    });
    const text = await r.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!r.ok) throw new Error(json?.error || json?.message || text);
    return json;
  }

  function showStartJSON(obj) {
    if (!startDebugEl) return;
    startDebugEl.textContent = obj ? JSON.stringify(obj, null, 2) : "";
  }

  function showLK(msgOrObj) {
  if (!lkDebugEl) return;
  const line = (typeof msgOrObj === "string")
    ? msgOrObj
    : JSON.stringify(msgOrObj, null, 0);

  lkDebugEl.textContent += line + "\n";
  lkDebugEl.scrollTop = lkDebugEl.scrollHeight;
}

  function cleanupMedia() {
    if (attachedVideoEl) {
      attachedVideoEl.srcObject = null;
      attachedVideoEl.remove();
      attachedVideoEl = null;
    }
    if (attachedAudioEl) {
      attachedAudioEl.srcObject = null;
      attachedAudioEl.remove();
      attachedAudioEl = null;
    }
    if (videoHint) videoHint.style.display = "flex";
  }

  function startTimer() {
    clearInterval(countdown);
    secondsLeft = 60;
    document.getElementById("timer").textContent = secondsLeft + "s";
    countdown = setInterval(async () => {
      secondsLeft -= 1;
      document.getElementById("timer").textContent = secondsLeft + "s";
      if (secondsLeft <= 0) {
        clearInterval(countdown);
        await stopSession();
      }
    }, 1000);
  }

  async function connectLiveKit(payload) {
    if (!window.LivekitClient) {
      throw new Error("LivekitClient –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CDN livekit-client.");
    }

    const lkUrl = payload?.livekit_url;
    const lkToken = payload?.livekit_client_token; // –í–ê–ñ–ù–û: client token

    if (!lkUrl || !lkToken) {
      throw new Error("–í payload –Ω–µ—Ç livekit_url –∏–ª–∏ livekit_client_token.");
    }

    // –µ—Å–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
    if (room) {
      try { room.disconnect(); } catch {}
      room = null;
    }
    cleanupMedia();

    const { Room, RoomEvent } = window.LivekitClient;

    room = new Room({
      adaptiveStream: true,
      dynacast: true,
      autoSubscribe: true,
    });

    showLK({ step: "connecting", lkUrl });

    room.on(RoomEvent.ParticipantConnected, (p) => {
      showLK({ step: "participant_connected", identity: p.identity });
    });

    room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
  showLK({ step: "track_subscribed", kind: track.kind, from: participant?.identity || "remote" });
  try {

        if (track.kind === "video") {
          if (videoHint) videoHint.style.display = "none";

          if (attachedVideoEl) {
            attachedVideoEl.srcObject = null;
            attachedVideoEl.remove();
            attachedVideoEl = null;
          }

          const el = track.attach();
          el.autoplay = true;
          el.playsInline = true;
          el.style.width = "100%";
          el.style.height = "100%";
          el.style.objectFit = "cover";
          el.style.display = "block";
          videoContainer.appendChild(el);
          attachedVideoEl = el;

          showLK({ step: "video_attached", from: participant?.identity || "remote" });
        }

        if (track.kind === "audio") {
  // —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π audio element
  if (attachedAudioEl) {
    try { attachedAudioEl.pause?.(); } catch {}
    attachedAudioEl.srcObject = null;
    attachedAudioEl.remove();
    attachedAudioEl = null;
  }

  const ael = track.attach();
  ael.autoplay = true;
  ael.muted = false;
  ael.volume = 1;
  ael.playsInline = true;

  // –í–ê–ñ–ù–û: –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–∫–∞–∂–µ–º controls (–ø–æ—Ç–æ–º –≤–µ—Ä–Ω—ë—à—å display:none)
  ael.controls = true;
  ael.style.display = "block";
  ael.style.width = "320px";

  document.body.appendChild(ael);
  attachedAudioEl = ael;

  // —Ñ–æ—Ä—Å–∏–º play –∏ –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  Promise.resolve()
    .then(() => ael.play())
    .then(() => showLK({ step: "audio_play_ok" }))
    .catch((err) => showLK("audio_play_failed: " + (err?.message || String(err))));

  showLK({ step: "audio_attached", from: participant?.identity || "remote" });
}

      } catch (e) {
        showLK("trackSubscribed error: " + (e?.message || String(e)));
      }
    });

    room.on(RoomEvent.Disconnected, (reason) => {
      showLK({ step: "disconnected", reason: String(reason || "") });
      cleanupMedia();
      room = null;
    });

    await room.connect(lkUrl, lkToken);
// –≤–∞–∂–Ω–æ –¥–ª—è Chrome: —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ (–≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–∫–∞ Start —ç—Ç–æ –æ–∫)
if (typeof room.startAudio === "function") {
  try {
    await room.startAudio();
    showLK({ step: "audio_started_ok" });
  } catch (e) {
    showLK("audio_started_blocked: " + (e?.message || String(e)));
  }
}

// –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø–æ—Å–ª–µ –∫–æ–Ω–Ω–µ–∫—Ç–∞
document.getElementById("mic").disabled = false;

showLK({ step: "connected", room: room.name, sid: room.sid, remotes: room.remoteParticipants.size });

  }

  async function stopSession() {
    document.getElementById("status").textContent = "–°—Ç–∞—Ç—É—Å: –∑–∞–≤–µ—Ä—à–∞—é —Å–µ—Å—Å–∏—é‚Ä¶";
    try {
      await postJSON("/api/stop", { session_id: sessionId, session_token: sessionToken });

      if (room) {
        try { room.disconnect(); } catch {}
        room = null;
      }
      cleanupMedia();

      document.getElementById("status").textContent = "–°—Ç–∞—Ç—É—Å: —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–∫–∞–∑—ã–≤–∞—é CTA.";
      showLK({ step: "stopped_ok" });
    } catch (e) {
      document.getElementById("status").textContent = "–°—Ç–∞—Ç—É—Å: –æ—à–∏–±–∫–∞ STOP: " + (e?.message || String(e));
      showLK("stop error: " + (e?.message || String(e)));
    }
   document.getElementById("stop").disabled = true;
document.getElementById("mic").disabled = true;

  }

  document.getElementById("start").addEventListener("click", async () => {
    document.getElementById("status").textContent = "–°—Ç–∞—Ç—É—Å: –ø–æ–ª—É—á–∞—é session_token‚Ä¶";
lkDebugEl.textContent = "";
    showStartJSON(null);

    try {
      const tok = await postJSON("/api/token", { language: "ru" });
      sessionId = tok.session_id;
      sessionToken = tok.session_token;

      document.getElementById("status").textContent = "–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ä—Ç—É—é —Å–µ—Å—Å–∏—é‚Ä¶";

      const started = await postJSON("/api/start", { session_token: sessionToken });

      // —Ç–≤–æ–π —Ñ–æ—Ä–º–∞—Ç: started.data = payload
      const payload = started?.data ?? started;
      showStartJSON(payload);

      document.getElementById("status").textContent =
        "–°–µ—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞ ‚úÖ session_id=" + (payload?.session_id || sessionId);

      // CONNECT LIVEKIT
      await connectLiveKit(payload);

      document.getElementById("stop").disabled = false;
      startTimer();
    } catch (e) {
      document.getElementById("status").textContent = "–û—à–∏–±–∫–∞: " + (e?.message || String(e));
      showLK("start error: " + (e?.message || String(e)));
      console.error(e);
    }
  });

  document.getElementById("stop").addEventListener("click", stopSession);

document.getElementById("mic").addEventListener("click", async () => {
  try {
    if (!room) throw new Error("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ Start (–Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ LiveKit).");

    // –µ—Å–ª–∏ —É–∂–µ –≤–∫–ª—é—á–∞–ª–∏ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º
    if (localMicTrack) {
      try { await room.localParticipant.unpublishTrack(localMicTrack); } catch {}
      try { localMicTrack.stop(); } catch {}
      localMicTrack = null;

      document.getElementById("mic").textContent = "üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
      showLK({ step: "mic_off" });
      return;
    }

    showLK("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –º–∏–∫—Ä–æ—Ñ–æ–Ω‚Ä¶ (–±—Ä–∞—É–∑–µ—Ä —Å–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)");

    localMicTrack = await window.LivekitClient.createLocalAudioTrack({
      echoCancellation: true,
      noiseSuppression: true,
      autoGainControl: true,
    });

    await room.localParticipant.publishTrack(localMicTrack);

    document.getElementById("mic").textContent = "üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
    showLK({ step: "mic_published" });

  } catch (e) {
    showLK("mic error: " + (e?.message || String(e)));
  }
});

</script>

</body>
</html>
