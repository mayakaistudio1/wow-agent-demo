<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOW-Agent Demo (RU)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; }
    button { padding: 12px 14px; border: 1px solid #ddd; border-radius: 12px; background: #fff; cursor: pointer; text-align: left; }
    button:hover { border-color: #aaa; }
    .box { margin-top: 18px; padding: 14px; border: 1px solid #eee; border-radius: 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; }
    .primary { background:#111; color:#fff; border-color:#111; }
    .danger { background:#b00020; color:#fff; border-color:#b00020; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>WOW-Agent Demo Hub (RU)</h1>
  <p>Выбери роль → старт → <b>60 сек</b> → стоп сессии → CTA.</p>

  <div class="grid" id="roles">
    <button data-role="sales"><b>Клиенты и продажи</b><br><small>заявки / консультации / дожим</small></button>
    <button data-role="partners"><b>Партнёры и команда</b><br><small>рекрутинг / онбординг</small></button>
    <button data-role="investor"><b>Инвестор</b><br><small>питч / цифры / формат</small></button>
    <button data-role="support"><b>Поддержка</b><br><small>FAQ / разгрузка</small></button>
  </div>

  <div class="box">
    <div class="row">
      <label>Имя:</label>
      <input id="name" placeholder="Например: Яков" />
      <span>Роль: <code id="role">—</code></span>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="primary" id="start">Старт (получить токен)</button>
      <button class="danger" id="stop" disabled>Завершить</button>
      <span>Таймер: <code id="timer">—</code></span>
    </div>

    <p id="status" style="margin-top:12px">Статус: ждём выбора роли.</p>

    <!-- ВАЖНО:
         Тут позже вставим реальный рендер LiveAvatar через SDK.
         Сейчас мы проверяем инфраструктуру: токен + стоп. -->
  </div>

  <div class="box">
    <b>CTA после демо:</b>
    <p>Хочешь демо под твою нишу за 48 часов? → <a href="#">забронировать 15 минут</a></p>
  </div>

<script>
  let chosenRole = null;
  let countdown = null;
  let secondsLeft = 0;
  let sessionId = null; // сюда положим id сессии, когда подключим SDK/Start

  document.querySelectorAll('#roles button').forEach(btn => {
    btn.addEventListener('click', () => {
      chosenRole = btn.dataset.role;
      document.getElementById('role').textContent = chosenRole;
      document.getElementById('status').textContent = 'Статус: роль выбрана, можно стартовать.';
    });
  });

  async function postJSON(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(body || {})
  });

  const text = await r.text();

  // если сервер вернул ошибку — покажем её как есть
  if (!r.ok) throw new Error(text);

  // если сервер вернул не-JSON — не ломаемся, а возвращаем raw
  try {
    return JSON.parse(text);
  } catch {
    return { raw: text };
  }
}



  function startTimer() {
    clearInterval(countdown);
    secondsLeft = 60;
    document.getElementById('timer').textContent = secondsLeft + 's';
    countdown = setInterval(async () => {
      secondsLeft -= 1;
      document.getElementById('timer').textContent = secondsLeft + 's';
      if (secondsLeft <= 0) {
        clearInterval(countdown);
        await stopSession();
      }
    }, 1000);
  }

  async function stopSession() {
    document.getElementById('status').textContent = 'Статус: завершаю сессию…';
    try {
      // ВАЖНО: stop реально заработает, когда у нас будет session_id.
      // Пока оставляем как готовую точку вызова.
      await postJSON('/api/stop', { session_id: sessionId });
      document.getElementById('status').textContent = 'Статус: сессия завершена. Показываю CTA.';
    } catch (e) {
      document.getElementById('status').textContent = 'Статус: STOP не сработал (пока нет session_id).';
      console.warn(e);
    }
    document.getElementById('stop').disabled = true;
  }

  document.getElementById('start').addEventListener('click', async () => {
    if (!chosenRole) {
      alert('Выбери роль (карточку) сначала.');
      return;
    }
    const name = document.getElementById('name').value || 'друг';

    document.getElementById('status').textContent = 'Статус: получаю токен…';
    try {
      const data = await postJSON('/api/token', { role: chosenRole, name });
      // data.token — токен LiveAvatar (FULL mode)
      document.getElementById('status').textContent =
        'Токен получен. Дальше подключаем SDK и стартуем сессию. token=' + (data.token?.slice(0,12) + '…');

      // Здесь позже будет реальный "start session" через SDK, где мы получим sessionId
      // sessionId = ...

      document.getElementById('stop').disabled = false;
      startTimer();
    } catch (e) {
  document.getElementById('status').textContent =
    'Ошибка получения токена: ' + (e?.message || String(e));
  console.error(e);
}

  });

  document.getElementById('stop').addEventListener('click', stopSession);
</script>
</body>
</html>
